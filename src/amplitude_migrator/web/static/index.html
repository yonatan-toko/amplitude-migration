<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Amplitude Migrator — UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root { --b:#111827; --m:#6b7280; --bg:#f8fafc; --card:#fff; --line:#e5e7eb; --pri:#2563eb; }
    html,body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--b); }
    header { background:#fff; border-bottom:1px solid var(--line); padding:14px 18px; }
    header h1 { margin:0 0 6px; font-size:18px; }
    header .muted { color:var(--m); font-size:13px; margin:2px 0; }
    nav { margin-top:10px; display:flex; gap:8px; }
    nav button { border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; }
    nav button.active { background:var(--pri); color:#fff; border-color:var(--pri); }
    main { display:grid; grid-template-columns: 1fr; gap:16px; padding:16px; max-width:1100px; margin:0 auto; }
    .tab { display:none; }
    .tab.active { display:block; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:16px; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    label { display:block; font-size:14px; margin:8px 0; }
    input[type=text], input[type=password], input[type=number], textarea, select {
      width:100%; padding:8px; border:1px solid var(--line); border-radius:8px; background:#fff;
      font-size:14px;
    }
    textarea { min-height:80px; }
    .checkbox { display:flex; align-items:center; gap:8px; }
    .actions { margin-top:12px; display:flex; align-items:center; gap:10px; }
    .btn { background:var(--pri); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.ghost { background:transparent; color:var(--pri); border:1px solid var(--pri); }
    .muted { color:var(--m); }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; border-bottom:1px solid var(--line); padding:8px; font-size:14px; }
    th { background:#f1f5f9; position:sticky; top:0; }
    pre { white-space:pre-wrap; background:#0b1020; color:#e5e7eb; border-radius:10px; padding:12px; font-size:12px; overflow:auto; }
    code { background:#eef2ff; padding:1px 6px; border-radius:6px; }
    /* inline help tooltips */
    .info { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; margin-left:6px; border-radius:50%; font-size:12px; line-height:18px; cursor:help; color:#2563eb; background:#e0e7ff; user-select:none; position:relative; }
    .info::after {
      content: attr(data-tip);
      position:absolute; z-index:20; left:50%; transform:translateX(-50%);
      bottom: calc(100% + 8px);
      min-width: 220px; max-width: 420px;
      background:#0b1020; color:#e5e7eb; padding:8px 10px; border-radius:8px; font-size:12px; line-height:1.35; box-shadow:0 6px 18px rgba(0,0,0,.25);
      opacity:0; pointer-events:none; transition: opacity .12s ease;
      white-space:normal; text-align:left;
    }
    .info::before {
      content:""; position:absolute; left:50%; transform:translateX(-50%);
      bottom: calc(100% + 4px);
      border:6px solid transparent; border-top-color:#0b1020;
      opacity:0; transition: opacity .12s ease;
    }
    .info:hover::after, .info:focus::after, .info:active::after,
    .info:hover::before, .info:focus::before, .info:active::before { opacity:1; }
  </style>
</head>
<body>
  <header>
    <h1>Amplitude Project → Project Migrator</h1>
    <p class="muted">Edit <code>config.py</code> entirely from this UI. No file editing required.</p>
    <p class="muted">Reports dir: <code id="reportsDir">detecting…</code></p>
    <nav>
      <button data-tab="settings" class="active">Settings</button>
      <button data-tab="run">Run</button>
      <button data-tab="reports">Reports</button>
    </nav>
  </header>

  <main>
    <!-- SETTINGS -->
    <section id="tab-settings" class="tab active">
      <div class="card">
        <form id="settings-form">
          <h2>Source</h2>
          <label>Source API Key <span class="info" data-tip="Amplitude API key for the SOURCE project. Required when using the Export API.">ⓘ</span>
            <input name="SOURCE_PROJECT_API_KEY" type="password" placeholder="src key"/>
          </label>
          <div class="row2">
            <label>Region <span class="info" data-tip="Data center of the SOURCE project (US or EU). Must match the project you export from.">ⓘ</span>
              <select name="SOURCE_REGION">
                <option>US</option><option>EU</option>
              </select>
            </label>
            <label>Local Export (.json.gz) <span class="info" data-tip="Optional. Use a local Amplitude export (.json.gz). If set, the Export API window is ignored.">ⓘ</span>
              <input name="LOCAL_EXPORT_GZ_PATH" type="text" placeholder="/path/file.json.gz"/>
            </label>
          </div>
          <div class="row2">
            <label>Export Start (YYYY-MM-DD) <span class="info" data-tip="Start date for Export API (UTC). Use with Export End when not using a local file.">ⓘ</span>
              <input name="EXPORT_START" type="text" placeholder="2025-08-01"/>
            </label>
            <label>Export End (YYYY-MM-DD) <span class="info" data-tip="End date for Export API (UTC). Must be on or after the start date.">ⓘ</span>
              <input name="EXPORT_END" type="text" placeholder="2025-08-20"/>
            </label>
          </div>

          <h2>Destination</h2>
          <label>Dest API Key <span class="info" data-tip="Amplitude API key for the DESTINATION project where events will be written.">ⓘ</span>
            <input name="DEST_PROJECT_API_KEY" type="password" placeholder="dest key"/>
          </label>
          <label>Region <span class="info" data-tip="Data center of the DESTINATION project (US or EU). Must match that project.">ⓘ</span>
            <select name="DEST_REGION">
              <option>US</option><option>EU</option>
            </select>
          </label>

          <h2>Events & Properties</h2>
          <label>Event Allowlist (comma-separated) <span class="info" data-tip="Only migrate these event types. Leave empty to migrate all events.">ⓘ</span>
            <input name="EVENT_ALLOWLIST" type="text" placeholder="event_1, event_2"/>
          </label>
          <label>Property Keep (JSON) <span class="info" data-tip='JSON map of event→properties to keep. Use "*" to keep all. Example: {"*":["*"], "visit_submitted":["doctorName","visitDate"]}'>ⓘ</span>
            <textarea name="EVENT_PROPERTY_KEEP" placeholder='{"*":["*"], "event_1":["Property_1","Property_2"]}'></textarea>
          </label>
          <div class="row2">
            <label>Event Rename Map (JSON) <span class="info" data-tip='Optional JSON mapping of old event names to new ones. Example: {"visit_submitted":"visit_created"}'>ⓘ</span>
              <textarea name="EVENT_RENAME_MAP" placeholder='{"event_1":"event_1_new_name"}'></textarea>
            </label>
            <label>Property Rename Map (JSON) <span class="info" data-tip='Optional JSON mapping of old property keys to new keys per event. Example: {"visit_submitted":{"doctor":"doctorName"}}'>ⓘ</span>
              <textarea name="EVENT_PROP_RENAME_MAP" placeholder='{"event_1":{"Property_1":"Property_1_new_name"}}'></textarea>
            </label>
          </div>

          <h2>IDs</h2>
          <div class="row2">
            <label>Remap Scope <span class="info" data-tip="Choose which identifiers to remap using your CSV: user_id, device_id, or both.">ⓘ</span>
              <select name="REMAP_SCOPE">
                <option>user_id</option><option>device_id</option><option>both</option>
              </select>
            </label>
            <label>ID Map CSV path <span class="info" data-tip='CSV with headers old_id,new_id. You can also use the Upload button below to select a file.'>ⓘ</span>
              <input name="USER_ID_REMAP_PATH" type="text" placeholder="/path/to/id_map.csv"/>
            </label>
          </div>
          <label>Upload/Replace ID Map CSV <span class="info" data-tip="Upload a CSV and the path will be saved into config.py automatically.">ⓘ</span>
            <input id="idmap-file" type="file" accept=".csv"/>
            <button id="btn-upload" type="button" class="btn ghost">Upload</button>
            <span id="upload-result" class="muted"></span>
          </label>

          <h2>Time</h2>
          <div class="row2">
            <label>Time Strategy <span class="info" data-tip="Which timestamp to send to Amplitude: client time, server times, or a fallback strategy.">ⓘ</span>
              <select name="TIME_STRATEGY" id="time-strategy"></select>
            </label>
            <label class="checkbox">
              <input name="ORIGINAL_TIMES_AS_PROPERTIES" type="checkbox"/> Preserve originals in <code>_migration</code> <span class="info" data-tip="Adds original timestamps under the _migration object for auditing.">ⓘ</span>
            </label>
          </div>

          <h2>Run & Reports</h2>
          <div class="row2">
            <label>Reports Dir <span class="info" data-tip="Where run JSON reports are saved. The UI reads from this folder.">ⓘ</span>
              <input name="REPORTS_DIR" type="text" placeholder="/path/to/migration_runs"/>
            </label>
            <label>Samples Limit <span class="info" data-tip="How many transformed events to store as samples per run (for the UI).">ⓘ</span>
              <input name="REPORT_SAMPLE_LIMIT" type="number" min="0" step="1" />
            </label>
          </div>
          <label class="checkbox"><input name="DRY_RUN" type="checkbox"/> Default to Dry Run <span class="info" data-tip="Dry run reads and transforms but does not send to the destination.">ⓘ</span></label>
          <label class="checkbox"><input name="VERBOSE" type="checkbox"/> Verbose <span class="info" data-tip="Print more logs during migration.">ⓘ</span></label>

          <div class="actions">
            <button type="submit" class="btn">Save Settings</button>
            <span id="save-status" class="muted"></span>
          </div>
        </form>
      </div>
    </section>

    <!-- RUN -->
    <section id="tab-run" class="tab">
      <div class="card">
        <div class="actions">
          <button id="btn-dry-run" class="btn ghost">Run (Dry)</button>
          <button id="btn-real-run" class="btn">Run (Send)</button>
          <span id="run-status" class="muted"></span>
        </div>
        <pre id="run-output">// run summary will appear here</pre>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="tab-reports" class="tab">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h2 style="margin:0;">Run History</h2>
          <button id="refreshBtn" class="btn ghost">Refresh</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Report</th><th>Started</th><th>Duration (s)</th><th>Read</th><th>Kept</th><th>Sent</th><th>MTU</th><th>Est. Cost</th><th>Mode</th><th></th>
            </tr>
          </thead>
          <tbody id="runsBody"><tr><td colspan="10" class="muted">Loading…</td></tr></tbody>
        </table>

        <h3>Details</h3>
        <pre id="detailJson" class="muted">Select a run to view details</pre>
      </div>
    </section>
  </main>

  <!-- reports-dir probe -->
  <script>
    (function(){
      fetch('/api/migration/reports-dir')
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(d => { const el = document.getElementById('reportsDir'); if (el) el.textContent = d.reports_dir || '(not set)'; })
        .catch(() => { const el = document.getElementById('reportsDir'); if (el) el.textContent = '(unable to detect)'; });
    })();
  </script>
  <script src="./script.js"></script>
</body>
</html>